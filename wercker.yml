box: ruby:2.2.3
command-timeout: 60

services:
  - postgres:9.4
  - nikitinsm/elasticsearch # includes elasticsearch-analysis-morphology-1.2.1 plugin
build:
  steps:
    - script:
      name: workaround for nokogiri
      code: gem update --system 2.4.8

    - bundle-install

    - script:
      name: copy configs
      code: cp -p config/wercker/*.yml config

    - install-packages:
      packages: postgresql-client

    - script:
      name: create db
      code: |
        createdb -h postgres -U postgres paupers_test
        
    - script:
        name: phantomjs
        code: |
          apt-get update && apt-get install build-essential dialog apt-utils software-properties-common chrpath libfreetype6 libfreetype6-dev libfontconfig1 libfontconfig1-dev libssl-dev libxft-dev -y
          wget -q --no-check-certificate -O /usr/local/share/phantomjs-1.9.7-linux-x86_64.tar.bz2 https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-1.9.7-linux-x86_64.tar.bz2
          sudo tar -xjf /usr/local/share/phantomjs-1.9.7-linux-x86_64.tar.bz2 -C /usr/local/share
          sudo ln -s /usr/local/share/phantomjs-1.9.7-linux-x86_64/bin/phantomjs /usr/local/share/phantomjs
          sudo ln -s /usr/local/share/phantomjs-1.9.7-linux-x86_64/bin/phantomjs /usr/local/bin/phantomjs
          sudo ln -s /usr/local/share/phantomjs-1.9.7-linux-x86_64/bin/phantomjs /usr/bin/phantomjs
          which phantomjs

    - script:
      name: migrate db
      code: RAILS_ENV=test rake db:migrate

    - script:
      name: rspec
      code: bundle exec rspec --profile --format=documentation
