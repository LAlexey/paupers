box: ruby:2.2.3
command-timeout: 60

services:
  - postgres:9.4
  - nikitinsm/elasticsearch # includes elasticsearch-analysis-morphology-1.2.1 plugin
build:
  steps:
    - script:
      name: workaround for nokogiri
      code: gem update --system 2.4.8

    - bundle-install

    - script:
      name: copy configs
      code: cp -p config/wercker/*.yml config

    - install-packages:
      packages: postgresql-client

    - script:
      name: create db
      code: |
        createdb -h postgres -U postgres paupers_test
        
    - script:
        name: phantomjs
        code: |
          mkdir -p vendor/bin
          wget -q --no-check-certificate -O /tmp/phantomjs-1.9.7-linux-x86_64.tar.bz2 https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-1.9.7-linux-x86_64.tar.bz2
          tar -xjf /tmp/phantomjs-1.9.7-linux-x86_64.tar.bz2 -C /tmp 
          mv /tmp/phantomjs-1.9.7-linux-x86_64/bin/phantomjs vendor/bin/phantomjs
          ln -s vendor/bin/phantomjs /usr/bin/phantomjs
          ln -s vendor/bin/phantomjs /usr/local/bin/phantomjs
          phantomjs

    - script:
      name: migrate db
      code: RAILS_ENV=test rake db:migrate

    - script:
      name: rspec
      code: bundle exec rspec --profile --format=documentation
